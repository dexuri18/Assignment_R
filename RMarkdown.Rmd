---
title: "The Weight and Hindfoot Length Relationships of Rodents in Southern Arizona"
author: "Deky and Tono"
date: "March 31, 2018"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gridExtra)
library("ggpubr")
```

## Summary of the Data

Data used in this assignment was derived from the time series data which were collected from 1977 to 2002 with the total numbers of recorded data is 34,786.  However, we found that some of the records are incomplete which could lead to bias in our analysis. Therefore, we excluded the incomplete data in our further analysis. The comparison of the complete and incomplete data entries can be seen in Figure below.



```{r plot1, echo=FALSE}
surveys <- read.csv("data/portal_data_joined.csv") 

count_all_records <- surveys %>% tally()
count_complete <- surveys %>%
  filter(!is.na(hindfoot_length)) %>%
  filter(!is.na(weight)) %>%
  filter(sex !="") %>%
  filter(species_id !="") %>%
  tally()

count_unclomplete <- count_all_records - count_complete

slices <- c(count_complete[1,1],count_unclomplete[1,1])
lbls <- c("complete records", "uncomplete records")
pct <- round(slices/sum(slices)*100)
lbls <- paste(lbls, pct) # add percents to labels 
lbls <- paste(lbls,"%",sep="") # ad % to labels 

pie(slices,labels = lbls, col=rainbow(length(lbls)),
    main="Pie Chart of Data Completeness")
```

The figure below delineates the general patterns of the data based on the number of samples for each species and genus, also the proportion of sex (female and male) for each category. 

```{r plot_a,echo=FALSE}
#load the data
surveys <- read.csv("data/portal_data_joined.csv")

#clean the data from NA and blank value
surveys_complete <- surveys %>%
  filter(!is.na(hindfoot_length)) %>%
  filter(!is.na(weight)) %>%
  filter(sex !="") %>%
  filter(species_id !="")

#plotting the number of species and assign it to variable
species_plot <- ggplot(data = surveys_complete) + geom_bar(mapping = aes(x = species_id, fill = sex)) +
  theme(axis.text.x = element_text(size = 8, angle = 90))

#plotting the number of genus and assign it to variable
genus_plot <- ggplot(data = surveys_complete) + geom_bar(mapping = aes(x = genus, fill = sex)) + 
  theme(axis.text.x = element_text(angle = 30, size = 8))

#combine species plot and genus plot together
grid.arrange(species_plot, genus_plot, ncol=2, widths=c(8,7))

```

In addition to the general pattern of the data in the above, we also plotted the distribution of weight and hindfoot length for the overall sample and the distribution of the average (mean) weight and hindfoot length for each species, as follows: 

```{r plot_b,echo=FALSE}
#load the data
surveys <- read.csv("data/portal_data_joined.csv")

#clean the data from NA and blank value
surveys_complete <- surveys %>%
  filter(!is.na(hindfoot_length)) %>%
  filter(!is.na(weight)) %>%
  filter(sex !="") %>%
  filter(species_id !="")

#weight and hindfoot_length distribution 
weight_distribution <- ggplot(data = surveys_complete, aes(x = weight)) + 
  geom_histogram(stat = "bin", binwidth = 3)
hlength_distribution <- ggplot(data = surveys_complete, aes(x = hindfoot_length)) + 
  geom_histogram(stat = "bin", binwidth = 2)

#mean weight and hindfoot length for each species
weight_sum <- aggregate(surveys_complete["weight"], surveys_complete["species_id"], FUN = mean)
weight_sum_plot <- ggplot(weight_sum, aes(x = species_id, y = weight)) + 
  geom_bar(stat = "identity") + theme(axis.text.x = element_text(size = 8, angle = 90))

hlength_sum <- aggregate(surveys_complete["hindfoot_length"], surveys_complete["species_id"], FUN = mean)
hlength_sum_plot <- ggplot(hlength_sum, aes(x = species_id, y = hindfoot_length)) + 
  geom_bar(stat = "identity") + theme(axis.text.x = element_text(size = 8, angle = 90))

#combine four plots together
grid.arrange(weight_distribution, hlength_distribution, weight_sum_plot, 
             hlength_sum_plot, ncol=2, widths=c(6,6))
```

##The Weight and Hindfoot Length Relationship Analysis

###All species

The general pattern of the weight and hindfoot length relationship of all species combined follows the bounded exponential trendline. Based on the R^2^ result, roughly around `r paste0(format((summary(lm(hindfoot_length ~ weight + log(weight), data = surveys_complete))$r.squared), digits = 3)) ` of the population are matched with this trendline. 

```{r plot_c,echo=FALSE}
#load the data
surveys <- read.csv("data/portal_data_joined.csv")

#clean the data from NA and blank value
surveys_complete <- surveys %>%
  filter(!is.na(hindfoot_length)) %>%
  filter(!is.na(weight)) %>%
  filter(sex !="") %>%
  filter(species_id !="")

#plotting the relationship between weight and hindfoot length for all species
plot_1 <- ggplot(surveys_complete, aes(x = weight, y = hindfoot_length, color = genus)) +
  geom_point(shape = 2, size = 1)
plot_2 <- plot_1 + geom_smooth(mapping = aes(linetype = "r2"), 
                               method = "lm",
                               formula = y ~ x + log(x), se = FALSE,
                               color = "red") 
plot_3 <- plot_2 + ggtitle("Relationship between weight and hindfoot length for all species") +
  scale_x_continuous(name = "Weight") + scale_y_continuous(name = "Hindfoot Length")
plot_4 <- plot_3 + theme_minimal() + 
  theme(text = element_text(color = "gray20"), 
        legend.position = c("right"), 
        legend.text = element_text(size = 8, color = "gray20"),
        axis.text = element_text(face = "italic"), 
        axis.title.x = element_text(size = 9, face = "bold", color = "gray20" ),
        axis.title.y = element_text(size = 9, face = "bold", color = "gray20"),
        title = element_text(size = 10, face = "bold", color = "gray20")) 
mR2 <- summary(lm(hindfoot_length ~ weight + log(weight), data = surveys_complete))$r.squared
mR2 <- paste0(format(mR2, digits = 3))
plot_4 + scale_linetype(name = "", breaks = "r2",
                 labels = list(bquote(R^2==.(mR2))), 
                 guide = guide_legend(override.aes = list(linetype = 1, size = 2, color = "red")))
```

###The most recorded species

From the distribution of the number of samples per species in the above, it shows that only four species that have recoded sample above 2500 entries from the period of 1977 to 2002. These species included, baileyi, merriami, ordii and penicillatus. Figures below are the summary of weight and length of hindfoot of the four species. 

```{r plot2,echo=FALSE}
#load the data
surveys <- read.csv("data/portal_data_joined.csv")

#clean the data from NA and blank value
surveys_complete <- surveys %>%
  filter(!is.na(hindfoot_length)) %>%
  filter(!is.na(weight)) %>%
  filter(sex !="") %>%
  filter(species_id !="")

#list of species with n >= 2500
species_count <- surveys_complete %>%
  group_by(species) %>%
  tally() %>%
  filter(n >= 2500)

#filter of the common sample (>= 2500)
surveys_common <- surveys_complete %>%
  filter(species %in% species_count$species)

ggplot(surveys_common, aes(x = species, y = weight)) + geom_boxplot()+xlab("Species")
```

From the results, the ordii species has the highest mean weight among the other, whereas, the merriami species has the highest hindfoot length followed by ordii species in the second place. 

```{r plot3,echo=FALSE}

#load the data
surveys <- read.csv("data/portal_data_joined.csv")

#clean the data from NA and blank value
surveys_complete <- surveys %>%
  filter(!is.na(hindfoot_length)) %>%
  filter(!is.na(weight)) %>%
  filter(sex !="") %>%
  filter(species_id !="")

#list of species with n >= 2500
species_count <- surveys_complete %>%
  group_by(species) %>%
  tally() %>%
  filter(n >= 2500)

#filter of the common sample (>= 2500)
surveys_common <- surveys_complete %>%
  filter(species %in% species_count$species)

ggplot(surveys_common, aes(x = species, y = hindfoot_length)) + geom_boxplot()+xlab("Species")

```

###The linear model of weight and hindfoot length of the merriami species

In order to analyze the weight and hindfoot length relationship thoroughly, we analyze the data from the species which has the most significant sample number which is *merriami* species. The analysis was done using the linear model, with summary as follows:

```{r plot5,echo=FALSE}
#load the data
surveys <- read.csv("data/portal_data_joined.csv") 

#clean the data from NA and blank value
surveys_complete <- surveys %>%
  filter(!is.na(hindfoot_length)) %>%
  filter(!is.na(weight)) %>%
  filter(sex !="") %>%
  filter(species_id !="")

#filter of the common sample (>= 2500)
surveys_common <- surveys_complete %>%
  filter(species %in% species_count$species)

# Linier Model Analysis between weight and hindfoot length on the most common species

#create object for analysis : 
most_common_data <- surveys_common %>%
  filter(species == "merriami")

weight_vs_length <- select(most_common_data, weight, hindfoot_length)

#fitting linier model between weight and length of hindfoot
lm_weight_vs_length <- lm(hindfoot_length ~ weight, data=most_common_data)
summary(lm_weight_vs_length)
```

#### Coefficient - Estimate
The coefficient Estimate contains two rows; the first one is the intercept. The intercept is essentially the expected value of the length of hindfoot considering the average weight of all merriami in the dataset. In other words, it takes an average length of hindfoot in our dataset 32.69 mm to the weight. The second row in the Coefficients is the slope. The slope term in the model is saying that for every 1 gram increase in the weight, the length of hindfoot will goes up for 0.076 mm.

#### Coefficient - Standard Error
The coefficient Standard Error measures the average amount that the coefficient estimates vary from the actual average value of our response variable. We can say that the length of hindfoot according to the weight that said previously can vary by 0.002024 mm. The Standard Errors can also be used to compute confidence intervals and to statistically test the hypothesis of the existence of a relationship between weight and length of hindfoot.

#### Coefficient - t value
The coefficient t-value is a measure of how many standard deviations the coefficient estimate is far away from 0. The t-statistic values are relatively far away from zero and are large relative to the standard error, which could **indicate a relationship exists**.

#### Coefficient - Pr(>t)
The Pr(>t) acronym found in the model output relates to the probability of observing any value equal or larger than t. A small p-value indicates that it is unlikely we will observe a relationship between the predictor (speed) and response (dist) variables due to chance. Typically, a p-value of 5% or less is a good cut-off point. From the model, the p-values are very close to zero. Three stars (or asterisks) represent a highly significant p-value. Consequently, a small p-value for the intercept and the slope indicates that we can conclude that **there is a relationship between length of hindfoot and weight on merriami**.

#### Residual Standard Error

Residual Standard Error is measure of the quality of a linear regression fit. Theoretically, every linear model is assumed to contain an error term E. Due to the presence of this error term, we are not capable of perfectly predicting our response variable (length of hindfoot) from the predictor (weight) one. The Residual Standard Error is the average amount that the response (length of hindfoot) will deviate from the true regression line. In our example, the actual legth of hindfoot can deviate from the true regression line by approximately 1.362 mm on average. In other words, given that the mean legth of hindfoot for all weight is 32.67 and that the Residual Standard Error is 1.362, we can say that the percentage error is (any prediction would still be off by) 4.17%. It's also worth noting that the Residual Standard Error was calculated with 9725 degrees of freedom. Simplistically, degrees of freedom are the number of data points that went into the estimation of the parameters used after taking into account these parameters (restriction). In this case, we had more than 9,000 data points and two parameters (intercept and slope).

#### Multiple R-squared, Adjusted R-squared

The R-squared (R2) statistic provides a measure of how well the model is fitting the actual data. It takes the form of a proportion of variance. R2 is a measure of the linear relationship between the predictor variable (weight) and the response / target variable (length of hindfoot). The R2 we get is 0.1277. Or roughly 13% of the variance found in the response variable (length of hindfoot) can be explained by the predictor variable (weight).

###Additional analysis

In addition to all analysis that been committed, we add the t-test statistical analysis to see if the mean weight and the hindfoot length of female species are significantly different from the male species. We also use the box plots to visualize the data for both variables. The result of this analysis can be seen below.  

```{r plot_d,echo=FALSE}
#load the data
surveys <- read.csv("data/portal_data_joined.csv")

#clean the data from NA and blank value
surveys_complete <- surveys %>%
  filter(!is.na(hindfoot_length)) %>%
  filter(!is.na(weight)) %>%
  filter(sex !="") %>%
  filter(species_id !="")

#testing the mean weight between sex to see the difference
#Is the mean weight of female is significantly different compared to the male?
##visualize the data using box plots
ggboxplot(surveys_complete, x = "sex", y = "weight", color = "sex", ylab = "Weight", xlab = "Sex")
##do the two population have the same variances? use "f-test". answer = no because p-value < 0.05
result_ftest_weight <- var.test(weight ~ sex, data = surveys_complete)
##is there any significant difference between female and male weights? use "t-test".
##answer = no, because p value > 0.05. (female and male = same)
t.test(weight ~ sex, data = surveys_complete, var.equal = FALSE)
```

In the mean weight analysis, the p-value of the test is 0.1337, which is higher than the significance level alpha = 0.05. With this result, we conclude that female's average weight is *not significantly different* from the male's average weight.

```{r plot_e,echo=FALSE}
#load the data
surveys <- read.csv("data/portal_data_joined.csv")

#clean the data from NA and blank value
surveys_complete <- surveys %>%
  filter(!is.na(hindfoot_length)) %>%
  filter(!is.na(weight)) %>%
  filter(sex !="") %>%
  filter(species_id !="")
#testing the mean hindfoot length between sex to see the difference
#Is the mean hindfoot length of female is significantly different compared to the male?
##visualize the data using box plots
ggboxplot(surveys_complete, x = "sex", y = "hindfoot_length", color = "sex", ylab = "Hindfoot Length", xlab = "Sex")
##do the two population have the same variances? use "f-test". answer = no because p-value < 0.05
result_ftest_hindfootlength <-var.test(hindfoot_length ~ sex, data = surveys_complete)
##is there any significant difference between female and male hindfoot length? use "t-test".
##answer = no, because p value > 0.05. (female and male = same)
t.test(hindfoot_length ~ sex, data = surveys_complete, var.equal = FALSE)

```

In the mean hindfoot length analysis, the p-value of the test is < 2.2e-16, which is a lot lesser than the significance level alpha = 0.05. It concludes that female's average hindfoot length is *significantly different* from the male's average hindfoot length. 
